# Live Monitoring via sys.dm_exec_requests



# ‚è±Ô∏è SQL Server Query Time Tracking: Elapsed & Remaining Time

This guide explains how to measure **elapsed time** and estimate **remaining time** for SQL queries in SQL Server using T-SQL, SSMS, and system views.

---

## ‚úÖ Elapsed Time (How Long the Query Took)

### 1. `SET STATISTICS TIME ON`

Returns CPU time and total elapsed time **after the query completes**.

```sql
SELECT 
    r.session_id,
    r.status,
    r.command,
    r.cpu_time / 1000 AS CPU_Seconds,
    r.total_elapsed_time / 1000 AS Elapsed_Seconds,
    r.estimated_completion_time / 1000 AS Estimated_Remaining_Seconds,
    r.percent_complete,
    r.start_time,
    s.text AS QueryText
FROM sys.dm_exec_requests r
CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) s
WHERE r.session_id = @@SPID;

```

üìå **Output Example:**
```
SQL Server Execution Times:
   CPU time = 16 ms,  elapsed time = 25 ms.
```

---
**Query Performance Log**
```
DECLARE @StartTime DATETIME = GETDATE();

-- Your full query here
-- (paste your full SELECT ... JOIN ... GROUP BY query)
```
USE [IMFAS-LIVE]

DECLARE @ReportDate DATE = '2022-04-01' -- Simplified date calculation

SELECT 
    tm.MappedZoneId + '-' + tm.ZoneName AS Region,
    ta.AreaId + '-' + ta.AreaName AS Area,
    tbl.branchId + '-' + tbl.branchName AS Unit,
    ed1.degName,
    CAST(em.empId AS VARCHAR) + '-' + em.empname AS [CDO Name],
    COALESCE(SUM(CASE WHEN mp.programName IN (
        'ABASON', 'BUNIAD', 'ENRICH (Asset Creation)', 'ENRICH (Livelihood Dev.)',
        'JAGORON', 'KGF-Sufolon', 'LIFT (Fish)', 'LIFT (Goat)', 'LIFT (Sheep)',
        'LRL', 'LRL-2nd Phase', 'NRBC_BB_RF_COVID-19', 'SDL', 'SUFOLON', 'WASH'
    ) THEN lo.outstandingP END), 0) AS [All Others Outstanding],
    COALESCE(SUM(CASE WHEN mp.programName IN (
        'AGROSOR', 'AGROSOR-MDP', 'AGROSOR-MDP-AF', 'Start-Up Capital', 'ENRICH (IGA)'
    ) THEN lo.outstandingP END), 0) AS [Agrosor Outstanding],
    COALESCE(SUM(CASE WHEN mp.programName IN (
        'ABASON', 'BUNIAD', 'ENRICH (Asset Creation)', 'ENRICH (Livelihood Dev.)',
        'JAGORON', 'KGF-Sufolon', 'LIFT (Fish)', 'LIFT (Goat)', 'LIFT (Sheep)',
        'LRL', 'LRL-2nd Phase', 'NRBC_BB_RF_COVID-19', 'SDL', 'SUFOLON', 'WASH'
    ) THEN lo.DueAmountP END), 0) AS [All Others Due],
    COALESCE(SUM(CASE WHEN mp.programName IN (
        'AGROSOR', 'AGROSOR-MDP', 'AGROSOR-MDP-AF', 'Start-Up Capital', 'ENRICH (IGA)'
    ) THEN lo.DueAmountP END), 0) AS [Agrosor Due],
    COALESCE(SUM(lo.outstandingP), 0) AS [Total Outstanding],
    COALESCE(SUM(lo.DueAmountP), 0) AS [Total Due]
FROM [IMFAS-ERP].dbo.EmployeeGenInfo e WITH (NOLOCK)
INNER JOIN [IMFAS-ERP].dbo.tblEmployeeMap m WITH (NOLOCK) 
    ON e.id = m.erp_employee_id
INNER JOIN (
    SELECT employee_ID, MAX(eduYear) AS Year 
    FROM [IMFAS-ERP].dbo.EmployeeEducation 
    GROUP BY employee_ID
) ed ON ed.employee_id = m.erp_employee_id
INNER JOIN [IMFAS-ERP].dbo.EmployeeEducation ed1 
    ON ed.employee_id = ed1.employee_id 
    AND ed.Year = ed1.eduYear
INNER JOIN [IMFAS-LIVE].dbo.Center cen WITH (NOLOCK) 
    ON m.imfas_employee_id = cen.program_organizer
INNER JOIN [IMFAS-LIVE].dbo.LoanAccountsOpeningLine lo WITH (NOLOCK) 
    ON lo.workingId = cen.centId
INNER JOIN LoanProductDef ld WITH (NOLOCK) 
    ON ld.ProductCode = lo.productCode
INNER JOIN MicrocreditProgram mp WITH (NOLOCK) 
    ON mp.id = ld.microcreditProgramType
INNER JOIN EmployeeGenInfo em 
    ON em.id = cen.program_organizer
INNER JOIN tblbranch tbl 
    ON tbl.id = lo.Branch_id
INNER JOIN tblconfiguration tc WITH (NOLOCK) 
    ON tc.branch_id = tbl.id
INNER JOIN tblBranchLines tl WITH (NOLOCK) 
    ON tl.branch_id = tbl.id
INNER JOIN tblarealines al WITH (NOLOCK) 
    ON al.area_id = tl.Area_id
INNER JOIN tblarea ta WITH (NOLOCK) 
    ON ta.id = al.area_id
INNER JOIN tblSubZoneLines sz WITH (NOLOCK) 
    ON sz.subZone_id = al.subzone_id
INNER JOIN tblzonelines tz WITH (NOLOCK) 
    ON tz.Zone_id = sz.Zone_id
INNER JOIN tempZoneMapping tm WITH (NOLOCK) 
    ON tm.ID = sz.Zone_id
WHERE lo.OpeningDate = @ReportDate
GROUP BY 
    tm.MappedZoneId + '-' + tm.ZoneName,
    ta.AreaId + '-' + ta.AreaName,
    tbl.branchId + '-' + tbl.branchName,
    em.empId,
    em.empname,
    ed1.degName
```

DECLARE @EndTime DATETIME = GETDATE();

SELECT 
    DATEDIFF(SECOND, @StartTime, @EndTime) AS Elapsed_Seconds,
    DATEDIFF(MILLISECOND, @StartTime, @EndTime) AS Elapsed_Milliseconds,
    @StartTime AS StartTime,
    @EndTime AS EndTime;
```



### 2. Manual Timer Using T-SQL

Measure elapsed time using `GETDATE()`:

```sql
DECLARE @StartTime DATETIME = GETDATE();

-- Your long-running query
WAITFOR DELAY '00:00:05'; -- Simulated delay

DECLARE @EndTime DATETIME = GETDATE();

SELECT 
    @StartTime AS StartTime,
    @EndTime AS EndTime,
    DATEDIFF(SECOND, @StartTime, @EndTime) AS ElapsedSeconds;
```

---

## ‚è≥ Remaining Time (Estimation)

### 1. System View: `sys.dm_exec_requests`

For operations like `BACKUP`, `RESTORE`, `ALTER INDEX`, etc.

```sql
SELECT 
    session_id,
    percent_complete,
    start_time,
    total_elapsed_time / 1000 AS ElapsedSeconds,
    estimated_completion_time / 1000 AS RemainingSeconds
FROM sys.dm_exec_requests
WHERE session_id = @@SPID;
```

üìå Note: `percent_complete` and `estimated_completion_time` only work for:
- BACKUP / RESTORE
- DBCC CHECKDB / SHRINK
- INDEX REBUILD

They **do not work for normal SELECT/INSERT/UPDATE** queries.

---

### 2. SSMS Client Statistics (GUI Method)

In SQL Server Management Studio:
1. Go to `Query > Include Client Statistics` or press `Shift + Alt + S`.
2. Run your query.
3. View **Execution Time** under the "Client Statistics" tab.

Use average from multiple runs to **estimate remaining** for future batches.

---

## üñ•Ô∏è Bonus: Track Time in Application Code

### C# Example:
```csharp
var stopwatch = new Stopwatch();
stopwatch.Start();

// Run SQL query

stopwatch.Stop();
Console.WriteLine($"Elapsed Time: {stopwatch.ElapsedMilliseconds} ms");
```

---

## üìä Summary

| Method                      | Elapsed Time | Remaining Time | Use Case                            |
|----------------------------|--------------|----------------|-------------------------------------|
| `SET STATISTICS TIME ON`   | ‚úÖ Yes        | ‚ùå No           | After query finishes                |
| `GETDATE()` or `SYSDATETIME()` | ‚úÖ Yes  | ‚ùå No           | Manual logging                      |
| `sys.dm_exec_requests`     | ‚úÖ Yes (if supported) | ‚úÖ Yes (if supported) | For BACKUP/RESTORE, etc.    |
| SSMS Client Statistics      | ‚úÖ Yes        | ‚ö†Ô∏è Approximate | Good for interactive queries        |
| Application Code (C#, etc) | ‚úÖ Yes        | ‚ùå No           | Track from external app             |

---

## üìö References

- [sys.dm_exec_requests (MS Docs)](https://learn.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql)
- [SET STATISTICS TIME](https://learn.microsoft.com/en-us/sql/t-sql/statements/set-statistics-time-transact-sql)

---

## üìÑ License

MIT License. Feel free to use or modify.
